<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TrainSafe Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <style>
        [x-cloak] { display: none; }
        /* Custom styles to ensure full height and proper background */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col">

    <div class="w-full bg-gradient-to-r from-indigo-500 to-blue-500 py-10">
        <div class="max-w-4xl mx-auto px-4 text-white">
  
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-xl -mt-6 sm:p-8 w-full mb-8 flex-grow" x-data="adminApp()">
        <h2 class="text-2xl font-bold mb-6 text-center text-indigo-800">Administrator Access</h2>

        <template x-if="!loggedIn">
            <div class="space-y-4 max-w-md mx-auto py-8"> <h3 class="text-xl font-semibold mb-4 text-center text-gray-800">Admin Login</h3>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" x-model="username" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" x-model="password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                </div>
                <button @click="login" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200 font-semibold text-lg mt-4">Login</button>
                <p x-cloak x-show="message" x-text="message" :class="message.includes('successful') ? 'text-green-600' : 'text-red-600'" class="text-center mt-3 text-sm"></p>
            </div>
        </template>

        <template x-if="loggedIn">
            <div class="space-y-6">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Manage Train Routes & Data</h3>
                    <button @click="logout()" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors duration-200 text-sm">Logout</button>
                </div>

                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h4 class="font-bold mb-4 text-indigo-700 text-lg">Select Route to Manage:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fromCity" class="block text-sm font-medium text-gray-700 mb-1">From City:</label>
                            <select id="fromCity" x-model="selectedFromCity" @change="updateSelectedRoute()" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                <option value="">Select From City</option>
                                <template x-for="city in uniqueCities" :key="city">
                                    <option :value="city" x-text="city"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label for="toCity" class="block text-sm font-medium text-gray-700 mb-1">To City:</label>
                            <select id="toCity" x-model="selectedToCity" @change="updateSelectedRoute()" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                <option value="">Select To City</option>
                                <template x-for="city in uniqueCities" :key="city">
                                    <option :value="city" x-text="city"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                    <p x-cloak x-show="selectedAdminRoute" class="mt-4 text-lg font-semibold text-indigo-800 p-2 bg-indigo-50 rounded-md">
                        Selected Route: <span x-text="getDisplayRouteName(selectedAdminRoute)"></span>
                    </p>
                    <p x-cloak x-show="!selectedAdminRoute && selectedFromCity && selectedToCity && selectedFromCity !== selectedToCity" class="mt-4 text-red-600 p-2 bg-red-50 rounded-md">
                        No trains listed for <span x-text="getDisplayRouteName(selectedFromCity + '-' + selectedToCity)"></span>. Select or add trains below.
                    </p>
                    <p x-cloak x-show="!selectedAdminRoute && (selectedFromCity === '' || selectedToCity === '')" class="mt-4 text-gray-600 p-2 bg-gray-50 rounded-md">
                        Please select both 'From' and 'To' cities to view/manage trains.
                    </p>
                </div>

                <template x-if="selectedAdminRoute">
                    <div class="space-y-6">
                        <button @click="showAddTrainForm = true; newTrain.route = selectedAdminRoute" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 font-semibold mt-4">Add New Train for <span x-text="getDisplayRouteName(selectedAdminRoute)"></span></button>

                        <div x-cloak x-show="showAddTrainForm" class="bg-indigo-50 p-6 rounded-lg shadow-md border border-indigo-200">
                            <h4 class="font-bold mb-4 text-indigo-800 text-lg">Add Train for <span x-text="getDisplayRouteName(selectedAdminRoute)"></span></h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Train ID (unique)</label>
                                    <input type="text" x-model="newTrain.id" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                    <input type="text" x-model="newTrain.name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM format)</label>
                                    <input type="text" x-model="newTrain.time" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">1st Class Price (Rs.)</label>
                                    <input type="number" x-model.number="newTrain.price_1st_class" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">2nd Class Price (Rs.)</label>
                                    <input type="number" x-model.number="newTrain.price_2nd_class" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900">
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button @click="addTrain" class="bg-green-600 text-white py-2.5 px-5 rounded-lg hover:bg-green-700 transition-colors duration-200 font-semibold">Submit Train</button>
                                <button @click="showAddTrainForm = false; resetNewTrainForm()" class="bg-gray-400 text-white py-2.5 px-5 rounded-lg hover:bg-gray-500 transition-colors duration-200 font-semibold">Cancel</button>
                            </div>
                        </div>

                        <div class="mt-6 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="font-bold mb-4 text-gray-800 text-lg">Existing Trains for <span x-text="getDisplayRouteName(selectedAdminRoute)"></span>:</h4>
                            <ul class="space-y-4">
                                <template x-for="train in trainsData[selectedAdminRoute]" :key="train.id">
                                    <li class="flex flex-col sm:flex-row sm:items-center justify-between bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-100">
                                        <div class="mb-2 sm:mb-0">
                                            <span class="font-bold text-gray-900" x-text="train.name"></span>
                                            <span class="text-sm text-gray-600 ml-2">(ID: <span x-text="train.id"></span>)</span>
                                            <span class="block sm:inline-block text-gray-700 mt-1 sm:mt-0 sm:ml-4">Time: <span x-text="train.time"></span></span>
                                            <span class="block sm:inline-block text-gray-700 mt-1 sm:mt-0 sm:ml-4">1st Class: Rs.<span x-text="train.price_1st_class"></span></span>
                                            <span class="block sm:inline-block text-gray-700 mt-1 sm:mt-0 sm:ml-4">2nd Class: Rs.<span x-text="train.price_2nd_class"></span></span>
                                        </div>
                                        <div>
                                            <button @click="deleteTrain(selectedAdminRoute, train.id)" class="bg-red-500 text-white text-sm py-2 px-4 rounded-md hover:bg-red-600 transition-colors duration-200 font-semibold">Delete</button>
                                        </div>
                                    </li>
                                </template>
                                <template x-if="!trainsData[selectedAdminRoute] || trainsData[selectedAdminRoute].length === 0">
                                    <li><p class="text-gray-500 p-4 bg-yellow-50 border border-yellow-200 rounded-md">No trains available for this route. Add a new train above.</p></li>
                                </template>
                            </ul>
                        </div>

                        <p x-cloak x-show="adminMessage" x-text="adminMessage" :class="adminMessage.includes('successful') ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'" class="p-3 rounded-md text-center mt-3"></p>
                    </div>
                </template>
            </div>
        </template>
    </div>

<script>
    function adminApp() {
        return {
            username: '',
            password: '',
            loggedIn: localStorage.getItem('adminLoggedIn') === 'true',
            message: '',
            adminMessage: '',
            trainsData: {},
            availableRoutes: [],
            uniqueCities: [
                'Badulla',
                'Kandy',
                'Nuwara Eliya',
                'Colombo Fort',
                'Anuradhapura',
                'Polonnaruwa',
                'Jaffna'
            ],
            selectedFromCity: '',
            selectedToCity: '',
            selectedAdminRoute: '',
            showAddTrainForm: false,
            newTrain: {
                route: '',
                id: '',
                name: '',
                time: '',
                price_1st_class: 0,
                price_2nd_class: 0,
            },

            init() {
                console.log('Admin App Initializing...');
                if (this.loggedIn) {
                    this.fetchTrainsData();
                }
            },

            async login() {
                this.message = '';
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: this.username, password: this.password }),
                    });
                    const data = await response.json();
                    this.message = data.message || data.error;
                    if (response.ok) {
                        this.loggedIn = true;
                        localStorage.setItem('adminLoggedIn', 'true');
                        await this.fetchTrainsData();
                        this.setInitialRouteSelection();
                    }
                } catch (error) {
                    this.message = 'Network error during login.';
                    console.error('Login error:', error);
                }
            },

            logout() {
                this.loggedIn = false;
                localStorage.removeItem('adminLoggedIn');
                this.username = '';
                this.password = '';
                this.message = '';
                this.adminMessage = '';
                this.trainsData = {};
                this.availableRoutes = [];
                this.selectedFromCity = '';
                this.selectedToCity = '';
                this.selectedAdminRoute = '';
                this.showAddTrainForm = false;
                this.resetNewTrainForm();
            },

            async fetchTrainsData() {
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/trains');
                    if (response.ok) {
                        this.trainsData = await response.json();
                        this.availableRoutes = Object.keys(this.trainsData).sort();

                        // Preserve selected route
                        if (this.selectedAdminRoute && !this.availableRoutes.includes(this.selectedAdminRoute)) {
                            this.selectedAdminRoute = '';
                            this.selectedFromCity = '';
                            this.selectedToCity = '';
                        } else if (this.selectedAdminRoute) {
                            const parts = this.selectedAdminRoute.split('-');
                            if (parts.length === 2) {
                                this.selectedFromCity = this.getDisplayRouteName(parts[0]);
                                this.selectedToCity = this.getDisplayRouteName(parts[1]);
                            }
                        }
                    } else {
                        this.adminMessage = 'Failed to fetch train data.';
                        this.availableRoutes = [];
                    }
                } catch (error) {
                    this.adminMessage = 'Network error fetching train data.';
                    console.error('Network error fetching train data:', error);
                    this.availableRoutes = [];
                }
            },

            setInitialRouteSelection() {
                if (this.uniqueCities.includes('Colombo Fort')) {
                    this.selectedFromCity = 'Colombo Fort';
                } else if (this.availableRoutes.length > 0) {
                    const firstRoute = this.availableRoutes[0];
                    const parts = firstRoute.split('-');
                    if (parts.length === 2) {
                        this.selectedFromCity = this.getDisplayRouteName(parts[0]);
                        this.selectedToCity = this.getDisplayRouteName(parts[1]);
                        this.selectedAdminRoute = firstRoute;
                    }
                }
                this.updateSelectedRoute();
            },

            updateSelectedRoute() {
                this.showAddTrainForm = false;
                this.adminMessage = '';
                this.resetNewTrainForm();
                this.selectedAdminRoute = '';

                if (this.selectedFromCity && this.selectedToCity) {
                    if (this.selectedFromCity === this.selectedToCity) {
                        this.adminMessage = 'From and To cities cannot be the same.';
                        return;
                    }
                    const normalizedFrom = this.selectedFromCity.replace(/ /g, '-');
                    const normalizedTo = this.selectedToCity.replace(/ /g, '-');
                    this.selectedAdminRoute = `${normalizedFrom}-${normalizedTo}`;
                }
            },

            getDisplayRouteName(hyphenatedName) {
                return hyphenatedName.replace(/-/g, ' ');
            },

            async addTrain() {
                this.adminMessage = '';
                if (!this.selectedAdminRoute) {
                    this.adminMessage = 'Please select a route first using the From/To dropdowns.';
                    return;
                }
                if (!this.newTrain.id || !this.newTrain.name || !this.newTrain.time || this.newTrain.price_1st_class <= 0 || this.newTrain.price_2nd_class <= 0) {
                    this.adminMessage = 'Please fill all fields for the new train and ensure prices are positive.';
                    return;
                }

                this.newTrain.route = this.selectedAdminRoute;

                try {
                    const response = await fetch('http://127.0.0.1:5000/api/trains', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ route: this.newTrain.route, train: this.newTrain }),
                    });
                    const data = await response.json();
                    this.adminMessage = data.message || data.error;
                    if (response.ok) {
                        await this.fetchTrainsData();
                        this.showAddTrainForm = false;
                        this.resetNewTrainForm();
                    }
                } catch (error) {
                    this.adminMessage = 'Network error adding train.';
                    console.error('Add train error:', error);
                }
            },

            async deleteTrain(routeName, trainId) {
                this.adminMessage = '';
                if (confirm('Are you sure you want to delete this train? This action cannot be undone.')) {
                    try {
                        const response = await fetch(`http://127.0.0.1:5000/api/trains/${routeName}/${trainId}`, {
                            method: 'DELETE',
                        });
                        const data = await response.json();
                        this.adminMessage = data.message || data.error;
                        if (response.ok) {
                            this.fetchTrainsData();
                        }
                    } catch (error) {
                        this.adminMessage = 'Network error deleting train.';
                        console.error('Delete train error:', error);
                    }
                }
            },

            resetNewTrainForm() {
                this.newTrain = {
                    route: this.selectedAdminRoute,
                    id: '',
                    name: '',
                    time: '',
                    price_1st_class: 0,
                    price_2nd_class: 0,
                };
            }
        };
    }
</script>

</body>
</html>